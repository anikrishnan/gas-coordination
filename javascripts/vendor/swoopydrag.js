d3.swoopyDrag=function(){function j(a){var b=a[0].pos,c=a[2].pos,d=a[1].pos,e=k(c,d),f=k(d,b),g=k(b,c),h=Math.acos((e*e+f*f-g*g)/(2*e*f)),i=.5*e*f*Math.sin(h),j=e*f*g/4/i;j=Math.round(1e3*j)/1e3;var l=+(Math.PI/2>h),m=+((c[0]-b[0])*(d[1]-b[1])-(c[1]-b[1])*(d[0]-b[0])<0);return["M",b,"A",j,j,0,l,m,c].join(" ")}function k(a,b){return Math.sqrt(Math.pow(a[0]-b[0],2)+Math.pow(a[1]-b[1],2))}function l(a,b){a.attr("transform",function(a){var c="function"==typeof b?b(a):b;return"translate("+c+")"})}function m(a){return function(b){return b[a]}}var d,a=d3.scale.linear(),b=d3.scale.linear(),c=[],e=!1,f=d3.dispatch("drag"),g=d3.behavior.drag().on("drag",function(a){var b=d3.event.x,c=d3.event.y;a.textOffset=[b,c].map(Math.round),d3.select(this).call(l,a.textOffset),f.drag()}).origin(function(a){return{x:a.textOffset[0],y:a.textOffset[1]}}),h=d3.behavior.drag().on("drag",function(a){var b=d3.event.x,c=d3.event.y;a.pos=[b,c].map(Math.round);var d=d3.select(this.parentNode),e="",g=d.selectAll("circle").data();"A"==g[0].type?e=j(g):g.forEach(function(a){e=e+a.type+a.pos}),d.select("path").attr("d",e).datum().path=e,d3.select(this).call(l,a.pos),f.drag()}).origin(function(a){return{x:a.pos[0],y:a.pos[1]}}),i=function(i){d=i.selectAll("g").data(c),d.exit().remove(),d.enter().append("g"),d.call(l,function(c){return[a(c),b(c)]});var j=d.append("text").call(l,m("textOffset")).text(m("text"));d.append("path").attr("d",m("path")),e&&(d.style("cursor","pointer"),j.call(g),d.selectAll("circle").data(function(a){var b=[];if(~a.path.indexOf("A")){var c=d3.select(this.parentNode).select("path").node(),d=c.getTotalLength();b=[0,.5,1].map(function(a){var b=c.getPointAtLength(a*d);return{pos:[b.x,b.y],type:"A"}})}else{for(var e=1,f="M",g=0,h=1;h<a.path.length;h++){var i=a.path[h];","==i&&g++,"L"!=i&&"C"!=i&&2!=g||(b.push({pos:a.path.slice(e,h).split(","),type:f}),f=i,e=h+1,g=0)}b.push({pos:a.path.slice(e,h).split(","),type:f})}return b}).enter().append("circle").attr({r:8,fill:"rgba(0,0,0,0)",stroke:"#333","stroke-dasharray":"2 2"}).call(l,m("pos")).call(h),f.drag())};return i.annotations=function(a){return"undefined"==typeof a?c:(c=a,i)},i.x=function(b){return"undefined"==typeof b?a:(a=b,i)},i.y=function(a){return"undefined"==typeof a?b:(b=a,i)},i.draggable=function(a){return"undefined"==typeof a?e:(e=a,i)},d3.rebind(i,f,"on")};
